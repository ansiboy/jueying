define(["require", "exports", "maishu-chitu"], function (require, exports, chitu) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    /**
     * 说明：页面中元素的获取，都是实时 DOM 查询，而不是保存在一个变量中，是因为
     * 某些MVVM框架，可能会用到虚拟 DOM，把页面中的元素改写了。
     */
    // export const viewTagName = 'SECTION';
    exports.isCordovaApp = location.protocol === 'file:';
    class Page extends chitu.Page {
        constructor(params) {
            super(params);
            this.displayStatic = false;
            this.allowSwipeBackGestrue = false;
        }
    }
    exports.Page = Page;
    class Application extends chitu.Application {
        constructor(args) {
            super(args);
            this.pageShown = chitu.Callbacks();
            this.pageType = Page;
            if (isiOS)
                this.pageDisplayType = PageDisplayImplement;
            else
                this.pageDisplayType = LowMachinePageDisplayImplement;
        }
        createPage(routeData) {
            let page = super.createPage(routeData);
            //(page as Page).app = this;
            this.pageShown.fire(this, { page });
            return page;
        }
    }
    exports.Application = Application;
    var touch_move_time = 0;
    window.addEventListener('touchmove', function (e) {
        touch_move_time = Date.now();
    });
    var isiOS = (navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/) || []).filter(o => o).length > 0; //ios终端
    function calculateAngle(x, y) {
        let d = Math.atan(Math.abs(y / x)) / 3.14159265 * 180;
        return d;
    }
    class PageDisplayImplement {
        constructor(app) {
            this.animationTime = 400;
            this.app = app;
            this.windowWidth = window.innerWidth;
            this.previousPageStartX = 0 - this.windowWidth / 3;
        }
        enableGesture(page) {
            let startY, currentY;
            let startX, currentX;
            let moved = false;
            let SIDE_WIDTH = 20;
            let enable = false;
            let horizontal_swipe_angle = 35;
            let vertical_pull_angle = 65;
            let colse_position = window.innerWidth / 2;
            let previousPageStartX = 0 - window.innerWidth / 3;
            page.element.addEventListener('touchstart', function (event) {
                startY = event.touches[0].pageY;
                startX = event.touches[0].pageX;
                enable = startX <= SIDE_WIDTH;
            });
            page.element.addEventListener('touchmove', (event) => {
                currentX = event.targetTouches[0].pageX;
                currentY = event.targetTouches[0].pageY;
                //========================================
                // currentX < 0 表示 IOS 侧划
                if (isiOS && currentX < 0 || !enable) {
                    return;
                }
                //========================================
                let deltaX = currentX - startX;
                let angle = calculateAngle(deltaX, currentY - startY);
                if (angle < horizontal_swipe_angle && deltaX > 0) {
                    page.element.style.transform = `translate(${deltaX}px, 0px)`;
                    page.element.style.transition = '0s';
                    if (page.previous != null) {
                        page.previous.element.style.transform = `translate(${previousPageStartX + deltaX / 3}px, 0px)`;
                        page.previous.element.style.transition = '0s';
                        page.previous.element.style.display = 'block';
                    }
                    disableNativeScroll(page.element);
                    moved = true;
                    event.preventDefault();
                    console.log('preventDefault gestured');
                }
            });
            let end = (event) => {
                if (!moved)
                    return;
                let deltaX = currentX - startX;
                if (deltaX > colse_position) {
                    console.assert(this.app != null);
                    this.app.back();
                }
                else {
                    page.element.style.transform = `translate(0px, 0px)`;
                    page.element.style.transition = '0.4s';
                    if (page.previous) {
                        page.previous.element.style.transform = `translate(${previousPageStartX}px,0px)`;
                        page.previous.element.style.transition = `0.4s`;
                        window.setTimeout(function () {
                            page.previous.element.style.display = 'none';
                            page.previous.element.style.removeProperty('transform');
                            page.previous.element.style.removeProperty('transition');
                            page.element.style.removeProperty('transform');
                            page.element.style.removeProperty('transition');
                        }, 400);
                    }
                }
                moved = false;
            };
            page.element.addEventListener('touchcancel', (event) => end(event));
            page.element.addEventListener('touchend', (event) => end(event));
            /** 禁用原生的滚动 */
            function disableNativeScroll(element) {
                element.style.overflowY = 'hidden';
            }
            /** 启用原生的滚动 */
            function enableNativeScroll(element) {
                element.style.overflowY = 'scroll';
            }
        }
        show(page) {
            if (!page.gestured) {
                page.gestured = true;
                if (page.allowSwipeBackGestrue)
                    this.enableGesture(page);
            }
            let maxZIndex = 1;
            let pageElements = document.getElementsByClassName('mobile-page');
            for (let i = 0; i < pageElements.length; i++) {
                let zIndex = new Number(pageElements.item(i).style.zIndex || '0').valueOf();
                if (zIndex > maxZIndex) {
                    maxZIndex = zIndex;
                }
            }
            page.element.style.zIndex = `${maxZIndex + 1}`;
            page.element.style.display = 'block';
            if (page.displayStatic) {
                if (page.previous) {
                    page.previous.element.style.display = 'none';
                }
                return Promise.resolve();
            }
            page.element.style.transform = `translate(100%,0px)`;
            if (page.previous) {
                page.previous.element.style.transform = `translate(0px,0px)`;
                page.previous.element.style.transition = `${this.animationTime / 1000}s`;
            }
            return new Promise(reslove => {
                let delay = 100;
                window.setTimeout(() => {
                    page.element.style.transform = `translate(0px,0px)`;
                    page.element.style.transition = `${this.animationTime / 1000}s`;
                    if (page.previous) {
                        page.previous.element.style.transform = `translate(${this.previousPageStartX}px,0px)`;
                        //==================================================================
                        // 由于距离短，时间可以延迟
                        page.previous.element.style.transition = `${(this.animationTime + 200) / 1000}s`;
                    }
                }, delay);
                window.setTimeout(reslove, delay + this.animationTime);
            }).then(() => {
                page.element.style.removeProperty('transform');
                page.element.style.removeProperty('transition');
                if (page.previous) {
                    page.previous.element.style.display = 'none';
                    page.previous.element.style.removeProperty('transform');
                    page.previous.element.style.removeProperty('transition');
                }
            });
        }
        hide(page) {
            return new Promise(reslove => {
                //============================================
                // 如果 touchmove 时间与方法调用的时间在 500ms 以内，则认为是通过系统浏览器滑屏返回，
                // 通过系统浏览器滑屏返回，是不需要有返回效果的。
                let now = Date.now();
                if (!exports.isCordovaApp && isiOS && now - touch_move_time < 500 || page.displayStatic) {
                    page.element.style.display = 'none';
                    if (page.previous) {
                        page.previous.element.style.display = 'block';
                        page.previous.element.style.transition = `0s`;
                        page.previous.element.style.transform = 'translate(0,0)';
                    }
                    reslove();
                    return;
                }
                //============================================
                page.element.style.transition = `${this.animationTime / 1000}s`;
                page.element.style.transform = `translate(100%,0px)`;
                if (page.previous) {
                    page.previous.element.style.display = 'block';
                    let delay = 0;
                    if (!page.previous.element.style.transform) {
                        page.previous.element.style.transform = `translate(${this.previousPageStartX}px, 0px)`;
                        delay = 50;
                    }
                    window.setTimeout(() => {
                        page.previous.element.style.transform = `translate(0px, 0px)`;
                        page.previous.element.style.transition = `${(this.animationTime - delay) / 1000}s`;
                    }, delay);
                }
                window.setTimeout(() => {
                    page.element.style.display = 'none';
                    page.element.style.removeProperty('transform');
                    page.element.style.removeProperty('transition');
                    if (page.previous) {
                        page.previous.element.style.removeProperty('transform');
                        page.previous.element.style.removeProperty('transition');
                    }
                    reslove();
                }, 500);
            });
        }
    }
    class LowMachinePageDisplayImplement {
        constructor(app) {
            this.app = app;
            this.windowWidth = window.innerWidth;
        }
        enableGesture(page) {
            let startY, currentY;
            let startX, currentX;
            let moved = false;
            let SIDE_WIDTH = 20;
            let enable = false;
            let horizontal_swipe_angle = 35;
            let vertical_pull_angle = 65;
            let colse_position = window.innerWidth / 2;
            let previousPageStartX = 0 - window.innerWidth / 3;
            page.element.addEventListener('touchstart', function (event) {
                startY = event.touches[0].pageY;
                startX = event.touches[0].pageX;
                enable = startX <= SIDE_WIDTH;
                if (page.previous) {
                    page.previous.element.style.display = 'block';
                }
            });
            page.element.addEventListener('touchmove', (event) => {
                currentX = event.targetTouches[0].pageX;
                currentY = event.targetTouches[0].pageY;
                //========================================
                // currentX < 0 表示 IOS 侧划
                if (isiOS && currentX < 0 || !enable) {
                    return;
                }
                //========================================
                let deltaX = currentX - startX;
                let angle = calculateAngle(deltaX, currentY - startY);
                if (angle < horizontal_swipe_angle && deltaX > 0) {
                    page.element.style.transform = `translate(${deltaX}px, 0px)`;
                    page.element.style.transition = '0s';
                    disableNativeScroll(page.element);
                    moved = true;
                    event.preventDefault();
                    console.log('preventDefault gestured');
                }
            });
            let end = (event) => {
                if (!moved)
                    return;
                let deltaX = currentX - startX;
                if (deltaX > colse_position) {
                    console.assert(this.app != null);
                    this.app.back();
                }
                else {
                    page.element.style.transform = `translate(0px, 0px)`;
                    page.element.style.transition = '0.4s';
                    setTimeout(() => {
                        if (page.previous) {
                            page.previous.element.style.display = 'none';
                        }
                    }, 500);
                }
                setTimeout(() => {
                    page.element.style.removeProperty('transform');
                    page.element.style.removeProperty('transition');
                }, 500);
                moved = false;
            };
            page.element.addEventListener('touchcancel', (event) => end(event));
            page.element.addEventListener('touchend', (event) => end(event));
            /** 禁用原生的滚动 */
            function disableNativeScroll(element) {
                element.style.overflowY = 'hidden';
            }
            /** 启用原生的滚动 */
            function enableNativeScroll(element) {
                element.style.overflowY = 'scroll';
            }
        }
        show(page) {
            if (!page.gestured) {
                page.gestured = true;
                if (page.allowSwipeBackGestrue)
                    this.enableGesture(page);
            }
            let maxZIndex = 1;
            let pageElements = document.getElementsByClassName('page');
            for (let i = 0; i < pageElements.length; i++) {
                let zIndex = new Number(pageElements.item(i).style.zIndex || '0').valueOf();
                if (zIndex > maxZIndex) {
                    maxZIndex = zIndex;
                }
            }
            page.element.style.zIndex = `${maxZIndex + 1}`;
            page.element.style.display = 'block';
            if (page.displayStatic) {
                if (page.previous) {
                    page.previous.element.style.display = 'none';
                }
                return Promise.resolve();
            }
            page.element.style.transform = `translate(100%,0px)`;
            return new Promise(reslove => {
                const playTime = 500;
                let delay = 50;
                window.setTimeout(() => {
                    page.element.style.transform = `translate(0px,0px)`;
                    page.element.style.transition = `${playTime / 1000}s`;
                }, delay);
                window.setTimeout(reslove, delay + playTime);
            }).then(() => {
                page.element.style.removeProperty('transform');
                page.element.style.removeProperty('transition');
                if (page.previous) {
                    page.previous.element.style.display = 'none';
                }
            });
        }
        hide(page) {
            //============================================
            // 如果 touchmove 时间与方法调用的时间在 500ms 以内，则认为是通过滑屏返回，
            // 通过滑屏返回，是不需要有返回效果的。
            if (isiOS && Date.now() - touch_move_time < 500 || page.displayStatic) {
                page.element.style.display = 'none';
                if (page.previous) {
                    page.previous.element.style.display = 'block';
                    page.previous.element.style.removeProperty('transform');
                    page.previous.element.style.removeProperty('transition');
                }
                return Promise.resolve();
            }
            //============================================
            page.element.style.transform = `translate(100%,0px)`;
            page.element.style.transition = '0.4s';
            if (page.previous) {
                page.previous.element.style.display = 'block';
            }
            return new Promise(reslove => {
                window.setTimeout(function () {
                    page.element.style.display = 'none';
                    page.element.style.removeProperty('transform');
                    page.element.style.removeProperty('transition');
                    reslove();
                }, 500);
            });
        }
    }
});
